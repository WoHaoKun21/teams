<!DOCTYPE html>
<html lang="zh">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<title>管理员页面</title>
		<link rel="stylesheet" type="text/css" href="css/adminindex.css" />
		<script src="js/jquery-1.11.0.min.js"></script>
		<script>
			$(function() {
				$.ajax({
					url: "admindata.php?action=login",
					type: "POST",
					dataType: "json",
					success: function(data) {
						if (data.status == "10001") {
							data = data.data;
							var str = "<div class='spf_banner'><img src='img/img.jpg'></div><ul>";
							// 对数据进行遍历
							for (var i = 0 in data) {
								str += "<li><p>用户[<span class='spf_author'>" + data[i].author + "</span>]" +
									"<img src='img/face/" + data[i].face + "' class='spf_img'>" +
									" 时间：<span class='spf_time'>" + data[i].addTime + "</span></p>"

									+
									"<p class='spf_title'>标题：" + data[i].title + "</p>" +
									"内容：<p class='spf_content'>" + data[i].content + "</p>";
								if (data[i].reply) {
									str += "<p class='spf_reply'>管理员回复：" + data[i].reply + "</p>";
								}
								if (data[i].sh == 1) {
									str += "<div class='spf_set'><a data-href=" + data[i].messageId +
										">已审核</a> |";
								} else {
									str += "<div class='spf_set'><a data-href=" + data[i].messageId +
										" class='a1'>未审核</a> |";
								}
								str += " <a data-href=" + data[i].messageId +
									" class='a2'>删除</a> | <a data-href=" + data[i].messageId +
									" class='a3'>回复</a></div>" +
									"<p class='spf_dz'>已获得<a data-href=" + data[i].messageId +
									" class='dz'> " + data[i].zan + " </a>赞</p>"
							}
							// 输出信息
							$("#spf_container").html(str + "</ul>");
						}
					}
				});			
				var page = 1;
				var pagecount = 1;
				var num = 0;
				$(".page").text(page);
				// 获得总页数
				$.ajax({
					url:"data.php",
					type:"POST",
					success:function(data){
						num = data;
						pagecount = Math.ceil(num/5);
						$(".pagecount").text(pagecount);
					}
				});
				// 点击进入下一页
				$("#downPage").click(function() {
					if(page>pagecount){
						page = pagecount;
					}else{
						page = page+1;
						$(".page").text(page);
						if(page<=pagecount){
							$.ajax({
								url: "admindata.php?action=login&page=" + page,
								dataType: "json",
								type: "POST",
								success: function(data) {
									console.log(data);
									if (data.status == "10001") {
										data = data.data;
										// 将页数进行规定
										var str =
											"<div class='spf_banner'><img src='img/img.jpg'></div><ul>";
										// 对数据进行遍历
										for (var i = 0 in data) {
											str += "<li><p>用户[<span class='spf_author'>" + data[i].author +
												"</span>]" +
												"<img src='img/face/" + data[i].face + "' class='spf_img'>" +
												" 时间：<span class='spf_time'>" + data[i].addTime +
												"</span></p>"
							
												+
												"<p class='spf_title'>标题：" + data[i].title + "</p>" +
												"内容：<p class='spf_content'>" + data[i].content + "</p>";
											if (data[i].reply) {
												str += "<p class='spf_reply'>管理员回复：" + data[i].reply +
													"</p>";
											}
											if (data[i].sh == 1) {
												str += "<div class='spf_set'><a data-href=" + data[i]
													.messageId + ">已审核</a> |";
											} else {
												str += "<div class='spf_set'><a data-href=" + data[i]
													.messageId + " class='a1'>未审核</a> |";
											}
											str += " <a data-href=" + data[i].messageId +
												" <a class='a2'>删除</a> | <a data-href=" + data[i].messageId +
												" <a class='a3'>回复</a></div>" +
												"<p class='spf_dz'>已获得<a data-href=" + data[i].messageId +
												" class='dz'> " + data[i].zan + " </a>赞</p>"
										}
										// 输出信息
										$("#spf_container").html(str + "</ul>");
									}
								}
							});
						}
					}
					
				});
				$("#onPage").click(function() {
					if(page<=1){
						page = 1;
					}else{
						page = page-1;
						$(".page").text(page);
						if(page<=pagecount){
							$.ajax({
								url: "admindata.php?action=login&page=" + page,
								dataType: "json",
								type: "POST",
								success: function(data) {
									console.log(data);
									if (data.status == "10001") {
										data = data.data;
										// 将页数进行规定
										var str =
											"<div class='spf_banner'><img src='img/img.jpg'></div><ul>";
										// 对数据进行遍历
										for (var i = 0 in data) {
											str += "<li><p>用户[<span class='spf_author'>" + data[i].author +
												"</span>]" +
												"<img src='img/face/" + data[i].face + "' class='spf_img'>" +
												" 时间：<span class='spf_time'>" + data[i].addTime +
												"</span></p>"
							
												+
												"<p class='spf_title'>标题：" + data[i].title + "</p>" +
												"内容：<p class='spf_content'>" + data[i].content + "</p>";
											if (data[i].reply) {
												str += "<p class='spf_reply'>管理员回复：" + data[i].reply +
													"</p>";
											}
											if (data[i].sh == 1) {
												str += "<div class='spf_set'><a data-href=" + data[i]
													.messageId + ">已审核</a> |";
											} else {
												str += "<div class='spf_set'><a data-href=" + data[i]
													.messageId + " class='a1'>未审核</a> |";
											}
											str += " <a data-href=" + data[i].messageId +
												" class='a2'>删除</a> | <a data-href=" + data[i].messageId +
												" class='a3'>回复</a></div>" +
												"<p class='spf_dz'>已获得<a data-href=" + data[i].messageId +
												" class='dz'> " + data[i].zan + " </a>赞</p>"
										}
										// 输出信息
										$("#spf_container").html(str + "</ul>");
									}
								}
							});
						}
					}
					
				});
				// 点赞事件
				$(document).on("click", "a.dz", function() {
					var _this = $(this);
					var messageId = $(this).attr("data-href");
					var dzl = $(this).text();
					$.ajax({
						url: "dz.php?messageId=" + messageId + "&dzl=" + dzl,
						type: "POST",
						dataType: "json",
						success: function(data) {
							console.log(data);
							if (data.status == "10001") {
								console.log(data.msg);
								$(_this).text(data.dz);
							} else {
								console.log(data.msg);
							}
						}
					});
				});
				// 审核事件
				$(document).on("click", "a.a1", function() {
					var _this = $(this);
					var messageId = $(this).attr("data-href");
					$.ajax({
						url: "sh.php?messageId=" + messageId,
						type: "POST",
						dataType: "json",
						success: function(data) {
							console.log(data)
							if (data.status == "10001") {
								alert(data.msg);
								$(_this).text(data.sh);
							} else {
								alert(data.msg);
							}
						}
					});
				});
				// 删除留言
				$(document).on("click", "a.a2", function() {
					var _this = $(this);
					var messageId = $(this).attr("data-href");
					$.ajax({
						url: "delete.php?messageId=" + messageId,
						type: "POST",
						dataType: "json",
						success: function(data) {
							if (data.status == "10001") {
								alert(data.msg);
								location.href = "adminindex.html";
							} else {
								alert(data.msg);
							}
						}
					});
				});
				// 点击回复出现回复框
				var messageId;
				$(document).on("click", "a.a3", function() {
					$("#reply").fadeIn("1000");
					messageId = $(this).attr("data-href");
				});
				// 点击回复留言
				$("#bt1").click(function() {
					console.log($(".reply").val());
					$.ajax({
						url: "reply.php",
						type: "POST",
						dataType: "json",
						data: {
							reply: $("textarea.reply").val(),
							messageId: messageId
						},
						success: function(data) {
							if (data.status == "10001") {
								$("#reply").hide("1000");
								var x = confirm(data.msg + "是否跳转到首页？");
								if (x) {
									location.href = "adminindex.html";
								}
							} else {
								alert(data.msg);
							}
						}
					});
				});
		// 发表留言开始
				$("#nav li a:first").click(function() {
					$("div.liuyan").show();
				});
				// 循环输出头像
				var faces = "";
				for (var i = 1; i <= 42; i++) {
					faces += '<option value="' + i + '.gif">' + i + '.gif</option>';
				}
				$("#face").html(faces).change(function() {
					var _this = $(this).val(); // 创建当前对象
					console.log(_this);
					$("#img1").attr("src", "img/face/" + _this);
				});
				// 为空报错——————开始
				$("#form1").submit(function(e){
					if($("#fbauthor").text("")){
						$("#fbauthortips").text("用户名不能为空");
						e.preventDefault();
					}
					if($("#fbtitle").text("")){
						$("#fbtitletips").text("标题不能为空");
						e.preventDefault();
					}
					if($("#fbcontent").text("")){
						$("#fbcontenttips").text("内容不能为空");
						e.preventDefault();
					}
				});
				// 为空报错——————结束
				// 清除提示——————开始
				$("#fbauthor").focus(function(){$("#fbauthortips").text("*");});
				$("#fbtitle").focus(function(){$("#fbtitletips").text("*");});
				$("#fbcontent").focus(function(){$("#fbcontenttips").text("*");});
				// 清除提示——————结束
				// 发送数据————开始
				$("#fabubutton").click(function(){
					$("#liuyan").hide();
					var author = $("#fbauthor").val();
					var face = $("#face").val();
					var title = $("#fbtitle").val();
					var content = $("#fbcontent").val();
					$.ajax({
						url:"fabuLY.php",
						type:"POST",
						data:{author:author,face:face,title:title,content:content},
						dataType:"json",
						success:function(data){
							if(data.status == "10001"){
								alert(data.msg);
								location.href = "adminindex.html";
							}else{
								alert(data.msg);
							}
						}
					});
				});
				// 发送数据————结束
				// 关闭发布留言
				$("div.close").click(function(){
					$("div.liuyan").hide();
				})
		// 发表留言结束
				//到顶部
				$("#nav a:last").click(function(){
					// window.scrollTo(0,0);
					$("html").animate({"scrollTop":"0px"},200);
				})
				//登录页面
					//显示页面
				$("#nav li a:eq(1)").click(function(){
					$("#mask").show();
					$("#login").show();
					//关闭页面
					$("#login .close").click(function(){
						$("#mask").hide();
						$("#login").hide();
					})
					//登录操作
					$("#denglubutton").click(function(){
						if($("#userName").val() && $("#password").val()){ //判断是否为空
						//不为空发送ajax
								$.ajax({
									url:"check.php?action=login",
									type:"POST",
									data:{userName:$("#userName").val(),password:$("#password").val()},
									dataType:"json",
									success:function(data){
										if(data.result=="success"){
											localStorage.setItem("jwt",data.jwt);
												location.href="../usersindex.html";
										}else{
											alert(data.msg);
											// alert("a");
										}
									}
								})
							}else{ //为空报错
								alert("用户名或密码不能为空");
							}
						})
					});
		
		
		// 欢迎管理员登录
				var jwt = localStorage.getItem("jwt");
				console.log(jwt);
				if(jwt){
					$.ajax({
						url:"../check.php",
						type:"POST",
						headers:{"token":jwt},
						dataType:"json",
						success:function(data){
							if(data.result == "success"){
								$("#namegl").text(data.info.data.userName);
							}
						}
					});
				}
		// 欢迎管理员结束
				$("#nav a:eq(3)").click(function(){
					var jwt=localStorage.getItem("jwt");
					console.log(jwt)
					if(!!jwt){
						$.ajax({
							url:"check.php",
							type:"GET",
							cache:false,
							headers:{"token":localStorage.getItem("jwt")},
							dataType:"json",
							success:function(data){
								if(data.result=="success"){ //鉴权成功，取数据
									location.href="../usersindex.html";
								}else{
									alert(data.msg);
								}
							}
						});
					}else{
						alert("请登录");
					}
				});

		// 安全退出
				$("#loginout").click(function(){
					// 清除浏览器的jwt
					localStorage.removeItem("jwt");
					location.href = "../index.html";
				})
			})
		</script>
	</head>
	<body>
		<div class="name">欢迎管理员<span id="namegl"></span>登录 | <a href="javascript:;" id="loginout">注销</a></div>
		<div id="reply">
			<form>
				<textarea rows="5" cols="25" class="reply"></textarea><br>
				<input type="button" id="bt1" value="回复" />
			</form>
		</div>
		<div id="spf_container"></div>
		<div id="nav">
			<ul>
				<li><a href="javascript:;">发表 留言</a></li>
				<li><a href="javascript:;">我要 登录</a></li>
				<li><a href="../index.html">返回 游客</a></li>
				<li><a href="javascript:;">用户 页面</a></li>
				<li><a href="javascript:;">请求 帮助</a></li>
				<li><a href="javascript:;">联系 我们</a></li>
				<li><a class="top" href="javascript:;"><br>顶部</a></li>
			</ul>
		</div>
		<div class="liuyan">
			<div class="fabu">
				<h3>快来发布留言吧！</h3>
				<div class="close"><img src="img/关闭.png" width="15"></div>
				<form id="form1" action="fabuLY.php">
					<table>
						<tr>
							<td>头像：</td>
							<td>
								<select id="face">

								</select>
								<img src="img/face/1.gif" id="img1" width="45">
							</td>
						</tr>
						<tr>
							<td>发布者：</td>
							<td>
								<input type="text" id="fbauthor">
								<span id="fbauthortips">*</span>
							</td>
						</tr>
						<tr>
							<td>标题：</td>
							<td>
								<input type="text" id="fbtitle" class="title">
								<span id="fbtitletips">*</span>
							</td>
						</tr>
						<tr>
							<td>内容：</td>
							<td>
								<textarea id="fbcontent" cols="30" rows="10"></textarea>
								<span id="fbcontenttips">*</span>
							</td>
						</tr>
						<tr align="center">
							<td colspan="2">
								<input type="reset" value="清空内容" class="sub res" id="qkbutton">
								&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
								<input type="submit" value="发布留言" class="sub" id="fabubutton">
							</td>
						</tr>
					</table>
				</form>
			</div>
		</div>
		<footer>
			<a data-href="1" id="onPage">上一页</a> |
			<a data-href="1" id="downPage">下一页</a> |
			<button type="button">
				共<span class="page"></span> /
				<span class="pagecount"></span>页
			</button>
		</footer>
		
		<!--遮罩层-->
				<div id="mask"></div> 
		<!-- 登录页面 -->
				<div id="login">
					<div class="close"><img src="img/关闭.png" width="15"></div>
					<div class="comtitle">
						<h1><img src="img/computer.png"><span>登  录</span></h1>
					</div> 
					<br>
					
					<div class="shuru">
						<img class="img6" src="img/用户名.png">
						<input type="text" id="userName" placeholder="请输入用户名"><br>
						<img class="img8" src="img/密码.png">
						<input type="password" id="password" placeholder="请输入密码"><br>
						<input type="submit" name="submit" id="denglubutton" value="登  录">
					</div>
	</body>
</html>
