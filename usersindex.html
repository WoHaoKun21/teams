<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户页</title>
    <link rel="stylesheet" href="css/index.css">
    <script src="js/jquery-1.11.0.min.js"></script>
    <script>
        $(function(){
            //总记录数
            var rscount=0;
            //总页数
            var pagecount=1;
            //页码
            var page=1;
            //初始化总记录数和总页数--从后台获取总记录数，计算总页数 rscount.php提供总记录数接口
            
			//鉴权
			$.ajax({
				url:"check.php",
				type:"POST",
				cache:false,
				headers:{"token":localStorage.getItem("jwt")},
				dataType:"json",
				success:function(data){
					if(data.result=="success"){ //鉴权成功，取数据
						$("#usersName").html(data.info.data.userName);
			
			
			$.ajax({
                url:"rscount.php",
                type:"POST",
                dataType:"json",
                success:function(data){
                    rscount=data.rscount;
                    pagecount=Math.ceil(rscount/5);
					$("#page .dangqian").text(page);
					$("#page .all").text(pagecount);
                }
            })

            //显示留言
            $.ajax({
                url:"message.php",
                type:"POST",
				data:{page,page},
                dataType:"json",
                cache:false,
                success:function(data){
                    var str="";
                    if(data.status=="10001"){ //有留言
                        $.each(data.data,function(index,value){
                            str+='<div class="message" data-id='+value.messageId+'><img src="img/face/'+value.face+'" width="45">'
                            +'<div class="author">'+value.author+'</div>'
                            +'<div class="addTime">'+value.addTime+'</div>'
                            +'<ul><li class="title">标题：'+value.title+'</li>'
                                +'<li class="content">'+value.content+'</li>';
								if(value.reply2){
									str+='<li class="reply2">用户回复：'
										+value.reply2+'</li>';
								}
								if(value.reply){
									str+='<li class="reply">管理员回复：'+value.reply+'</li></ul>'
									+'<div class="zan" data-id='+value.messageId+'></div>'
									+'<div class="zannum">'+value.zan+'</div>'
									+'<a class="reply2" data-id='+value.messageId+' href="javascript:;">回复</a></div>';
								}else{
									str+='</ul><div class="zan" data-id='+value.messageId+'></div>'
										+'<div class="zannum">'+value.zan+'</div>'
										+'<a class="reply2" data-id='+value.messageId+' href="javascript:;">回复</a></div>';
								}
                         })
                        $("#main").html(str);
						dianzan();//调用点赞功能
                    }else{
						str+=data.msg;
                        $("#main").html(str);
					}
                }
            })

			//首页
			$("#page a:first").click(function(){
				page=1;
				$.ajax({
					url:"message.php",
					type:"POST",
					data:{page:page},
					dataType:"json",
					success:function(data){
						var str="";
						$.each(data.data,function(index,value){
							str+='<div class="message" data-id='+value.messageId+'><img src="img/face/'+value.face+'" width="45">'
							+'<div class="author">'+value.author+'</div>'
							+'<div class="addTime">'+value.addTime+'</div>'
							+'<ul><li class="title">标题：'+value.title+'</li>'
							+'<li class="content">'+value.content+'</li>';
							if(value.reply2){
								str+='<li class="reply2">用户回复：'
									+value.reply2+'</li>';
							}
							if(value.reply){
								str+='<li class="reply">管理员回复：'+value.reply+'</li></ul>'
								+'<div class="zan" data-id='+value.messageId+'></div>'
								+'<div class="zannum">'+value.zan+'</div>'
								+'<a class="reply2" data-id='+value.messageId+' href="javascript:;">回复</a></div>';
							}else{
								str+='</ul><div class="zan" data-id='+value.messageId+'></div>'
									+'<div class="zannum">'+value.zan+'</div>'
									+'<a class="reply2" data-id='+value.messageId+' href="javascript:;">回复</a></div>';
							}
						})
						$("#main").html(str);
						$("#page .dangqian").text(page);
						dianzan();//调用点赞功能
					}
				})
				
			});
			
			//下一页
			var flag=true; //当页数page大于等于最大页数pagecount后，不允许发送ajax请求
			$("#page a:last").click(function(){
				var str="";
				if(page>pagecount){  //如果页数page大于总页数pagecount
					page=pagecount;
				}else{
					if(page<pagecount){  //页数page小于总页数pagecount
						page=page+1;
					}else{  //如果页数page等于总页数pagecount，就不发送ajax请求了
						flag=false;
					}
					if(page<=pagecount && flag){
						$.ajax({
							url:"message.php",
							type:"POST",
							data:{page:page},
							dataType:"json",
							success:function(data){
								$.each(data.data,function(index,value){
								str+='<div class="message" data-id='+value.messageId+'><img src="img/face/'+value.face+'" width="45">'
								+'<div class="author">'+value.author+'</div>'
								+'<div class="addTime">'+value.addTime+'</div>'
								+'<ul><li class="title">标题：'+value.title+'</li>'
									+'<li class="content">'+value.content+'</li>';
									if(value.reply2){
										str+='<li class="reply2">用户回复：'
											+value.reply2+'</li>';
									}
									if(value.reply){
										str+='<li class="reply">管理员回复：'+value.reply+'</li></ul>'
										+'<div class="zan" data-id='+value.messageId+'></div>'
										+'<div class="zannum">'+value.zan+'</div>'
										+'<a class="reply2" data-id='+value.messageId+' href="javascript:;">回复</a></div>';
									}else{
										str+='</ul><div class="zan" data-id='+value.messageId+'></div>'
											+'<div class="zannum">'+value.zan+'</div>'
											+'<a class="reply2" data-id='+value.messageId+' href="javascript:;">回复</a></div>';
									}
								})
							$("#main").html(str);
							$("#page .dangqian").text(page);
							dianzan();//调用点赞功能
							}
						})
					}
				}
				
			});

			//上一页
			var flag1=true; //当页数page小于等于1后，不允许发送ajax请求
			$("#page a:eq(1)").click(function(){
				var str="";
				if(page<1){  //如果页数page大于总页数pagecount
					page=1;
				}else{
					if(page>1){  //页数page小于总页数pagecount
						page=page-1;
					}else{  //如果页数page等于总页数pagecount，就不发送ajax请求了
						flag1=false;
					}
					if(page>=1 && flag1){
						$.ajax({
							url:"message.php",
							type:"POST",
							data:{page:page},
							dataType:"json",
							success:function(data){
								$.each(data.data,function(index,value){
								str+='<div class="message" data-id='+value.messageId+'><img src="img/face/'+value.face+'" width="45">'
								+'<div class="author">'+value.author+'</div>'
								+'<div class="addTime">'+value.addTime+'</div>'
								+'<ul><li class="title">标题：'+value.title+'</li>'
									+'<li class="content">'+value.content+'</li>';
									if(value.reply2){
										str+='<li class="reply2">用户回复：'
											+value.reply2+'</li>';
									}
									if(value.reply){
										str+='<li class="reply">管理员回复：'+value.reply+'</li></ul>'
										+'<div class="zan" data-id='+value.messageId+'></div>'
										+'<div class="zannum">'+value.zan+'</div>'
										+'<a class="reply2" data-id='+value.messageId+' href="javascript:;">回复</a></div>';
									}else{
										str+='</ul><div class="zan" data-id='+value.messageId+'></div>'
											+'<div class="zannum">'+value.zan+'</div>'
											+'<a class="reply2" data-id='+value.messageId+' href="javascript:;">回复</a></div>';
									}
								})
							$("#main").html(str);
							$("#page .dangqian").text(page);
							dianzan();//调用点赞功能
							}
						})
					}
				}
				
			});
			
			}else{  //鉴权失败
						location.href="error.html";
					}
				}
			});
			
			//点赞功能
			function dianzan(){
				$(".zan").click(function(){
					var _this=$(this);//存储this对象
					
					$.ajax({
						url:"zan_chuli.php",
						type:"POST",
						data:{messageId:_this.attr("data-id")},
						dataType:"json",
						success:function(data){
							if(data.status=="10001"){
								_this.next().text(data.data.zan);
							}else{
								alert(data.msg);
							}
						}
					})
				
				})
			}

			//发布留言
			$("#nav a:first").click(function(){
				$("#mask").show();
				$(".fabu").show();
				//关闭留言面板
				$(".fabu .close").click(function(){
					$("#mask").hide();
					$(".fabu").hide();
				})
				//单击发布留言按钮-发送ajax
				$("#fabubutton").click(function(){
					$.ajax({
						url:"leavemessage.php",
						type:"POST",
						data:{author:$("#fbauthor").val(),title:$("#fbtitle").val(),content:$("#fbcontent").val,face:$("#face").val()},
						dataType:"json",
						success:function(data){
							if(data.status=="10001"){
								$("#mask").hide();
								$(".fabu").hide();
								$("#fbauthor").val("");
								$("#fbtitle").val("");
								$("#fbcontent").val("");
								$("#face").val("1.gif");
								alert("发布成功，等待管理员审核");
							}else{
								alert(data.msg);
							}
						}
					})
				})
				$("#qkbutton").click(function(){
					$("#fbauthor").val("");
					$("#fbtitle").val("");
					$("#fbcontent").val("");
					$("#face").val("1.gif");
				})
			})
			
			//头像
			var facestr="";
			for(var i=1;i<=42;i++){
				facestr+='<option value='+i+".gif>"+i+".gif</option>";
			}
			$("#face").html(facestr).change(function(){
				var _this=$(this);
				$("#img1").attr("src","img/face/"+_this.val());
			})


			//登录页面
				//显示页面
			// $("#nav a:eq(1)").click(function(){
			// 	$("#mask").show();
			// 	$("#login").show();
			// 	//关闭页面
			// 	$("#login .close").click(function(){
			// 		$("#mask").hide();
			// 		$("#login").hide();
			// 	})
				//登录操作
				// $("#denglubutton").click(function(){
				// 	if($("#userName").val() && $("#password").val()){ //判断是否为空
				// 		//不为空发送ajax
				// 		$.ajax({
				// 			url:"check.php?action=login",
				// 			type:"POST",
				// 			data:{userName:$("#userName").val(),password:$("#password").val(),leixing:$("#login input:radio:checked").val()},
				// 			dataType:"json",
				// 			success:function(data){
				// 				if(data.result=="success"){
				// 					if($("#login input:radio:checked").val()=="1"){ //管理员
				// 						localStorage.setItem("jwt",data.jwt);
				// 						location.href="admin/adminindex.html";
				// 					}else{ //用户
				// 						localStorage.setItem("jwt",data.jwt);
				// 						location.href="usersindex.html";
				// 					}
				// 				}else{
				// 					alert(data.msg);
				// 				}
				// 			}
				// 		})
				// 	}else{ //为空报错
				// 		alert("用户名或密码不能为空");
				// 	}
				// })
			// })
			//返回游客页
			$("#nav a:eq(1)").click(function(){
				location.href="index.html";
			})

			//到顶部
			$("#nav a:last").click(function(){
				$("html").animate({"scrollTop":"0px"},200);
			})
			
			//注销
			$("#loginout").click(function(){
				localStorage.removeItem("jwt");
				location.href="index.html";
			})
			// 用户回复
			$(document).on("click", "a.reply2",function(){
				var x = prompt("请回复");
				var _this = $(this).attr("data-id");
				// 将获得的数据发送
				if(x){
					$.ajax({
						url:"ureply2.php",
						type:"POST",
						dataType:"json",
						data:{reply2:x,messageId:_this},
						success:function(data){
							console.log(data)
							if(data.status == "10001"){
								alert(data.msg);
								location.href = "usersindex.html";
							}else{
								alert(data.msg);
							}
						}
					});
				}else{
					alert("回复不能为空");
				}
			})
		})
    </script>
</head>
<body>
    <div class="container">
        <h1>wuhahah留言板--用户首页</h1>
		欢迎用户<span id="usersName"></span>登录
		<a href="javascript:;" id="loginout">注销</a>
<!--留言内容-->        
		<div id="main"></div> 

<!-- 右侧导航栏 -->
		<div id="nav">
			<ul>
				<li><a href="javascript:;">发表  留言</a></li>
				<li><a href="javascript:;">返回  游客</a></li>
				<li><a href="javascript:;">请求  帮助</a></li>
				<li><a href="javascript:;">联系 我们</a></li>
				<li><a class="top" href="javascript:;"><br>顶部</a></li>
			</ul>
		</div>
<!-- 页码 -->
		<div id="page">
			<a href="javascript:;">首页</a>
			<a href="javascript:;">上一页</a>
			<a href="javascript:;">下一页</a>
			共<span class="dangqian"></span>/<span class="all"></span>页
		</div>
<!--遮罩层-->
        <div id="mask"></div> 
<!--发表留言页面-->
        <div class="fabu">
			<h3>快来发布留言吧！</h3>
			<div class="close"><img src="img/关闭.png" width="15"></div>
				<table>
					<tr>
						<td>头像：</td>
						<td>
							<select id="face">

							</select>
							<img src="img/face/1.gif" id="img1" width="45">
						</td>
					</tr>
					<tr>
						<td>发布者：</td>
						<td><input type="text" id="fbauthor"></td>
					</tr>
					<tr>
						<td>标题：</td>
						<td><input type="text" id="fbtitle" class="title"></td>
					</tr>
					<tr>
						<td>内容：</td>
						<td><textarea id="fbcontent" cols="30" rows="10"></textarea></td>
					</tr>
					<tr align="center">
						<td colspan="2">
							<input type="reset" value="清空内容" class="sub res" id="qkbutton">
							&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
							<input type="submit" value="发布留言" class="sub" id="fabubutton">
						</td>
					</tr>
				</table>
		</div>
<!-- 登录页面 -->
		<!-- <div id="login">
			<div class="close"><img src="img/关闭.png" width="15"></div>
			<div class="comtitle">
				<h1><img src="img/computer.png"><span>登  录</span></h1>
			</div> 
			<br>
			
			<div class="shuru">
				<img class="img1" src="img/用户名.png">
				<input type="text" id="userName" placeholder="请输入用户名"><br>
				<img class="img2" src="img/密码.png">
				<input type="password" id="password" placeholder="请输入密码"><br>

				<input type="radio" name="leixing" value="0"> 用户
				<input type="radio" name="leixing" value="1"> 管理员
				
				<input type="submit" name="submit" id="denglubutton" value="登  录">
			</div>
		</div> -->
    </div>
</body>
</html>